{% extends "base.html" %}

{% block title %}Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1>Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</h1>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('attendance.add_attendance') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø­Ø¶ÙˆØ±
            </a>
        </div>
    </div>

    <!-- Search Form -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="form-inline">
                <div class="form-group me-3">
                    <label for="worker" class="me-2">Ø§Ù„Ø¹Ø§Ù…Ù„:</label>
                    <input type="text" name="worker" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„" value="{{ request.args.get('worker', '') }}">
                </div>
                <div class="form-group me-3">
                    <label for="date" class="me-2">Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                    <input type="date" name="date" class="form-control" value="{{ request.args.get('date', '') }}">
                </div>
                <button type="submit" class="btn btn-outline-primary">Ø¨Ø­Ø«</button>
            </form>
        </div>
    </div>

    <!-- Workers Accounts Summary -->
    <div class="row mb-3">
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ø§Ù„</h5>
                    <p class="card-text fs-3">{{ total_workers }}</p>
                    <small>Ø¹Ø§Ù…Ù„</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</h5>
                    <p class="card-text fs-3">{{ "%.1f"|format(total_all_hours) }}</p>
                    <small>Ø³Ø§Ø¹Ø©</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h5>
                    <p class="card-text fs-4">${{ "%.2f"|format(total_all_earnings_usd) }}</p>
                    <small>{{ "%.0f"|format(total_all_earnings_lbp) }} Ù„.Ù„</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù„ÙØ§Øª</h5>
                    <p class="card-text fs-4">${{ "%.2f"|format(total_all_advances_usd) }}</p>
                    <small>{{ "%.0f"|format(total_all_advances_lbp) }} Ù„.Ù„</small>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-calculator"></i> ØªÙØ§ØµÙŠÙ„ Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¹Ù…Ø§Ù„</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <strong>ğŸ“Š Ø´Ø±Ø­ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª:</strong> Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ã— Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¹Ø© = Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨ | Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨ - Ø§Ù„Ø³Ù„ÙØ© = Ø§Ù„Ø¨Ø§Ù‚ÙŠ
            </div>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th>
                            <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th>
                            <th>Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¹Ø© ($)</th>
                            <th>Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¹Ø© (Ù„.Ù„)</th>
                            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨ ($)</th>
                            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨ (Ù„.Ù„)</th>
                            <th>Ø§Ù„Ø³Ù„ÙØ© ($)</th>
                            <th>Ø§Ù„Ø¨Ø§Ù‚ÙŠ ($)</th>
                            <th>Ø§Ù„Ø¨Ø§Ù‚ÙŠ (Ù„.Ù„)</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for account in workers_accounts %}
                        <tr>
                            <td>
                                <strong>{{ account.worker.name }}</strong>
                                {% if account.worker.phone %}
                                <br><small class="text-muted">{{ account.worker.phone }}</small>
                                {% endif %}
                            </td>
                            <td class="text-info">
                                <strong>{{ "%.1f"|format(account.total_hours) }}</strong> Ø³Ø§Ø¹Ø©
                            </td>
                            <td class="text-primary">
                                ${{ "%.2f"|format(account.hourly_rate_usd) }}
                            </td>
                            <td class="text-primary">
                                {{ "%.0f"|format(account.hourly_rate_lbp) }} Ù„.Ù„
                            </td>
                            <td class="text-success">
                                <strong>${{ "%.2f"|format(account.total_earnings_usd) }}</strong>
                            </td>
                            <td class="text-success">
                                <strong>{{ "%.0f"|format(account.total_earnings_lbp) }} Ù„.Ù„</strong>
                            </td>
                            <td class="text-warning">
                                {% if account.total_advances_usd > 0 %}
                                    <strong>-${{ "%.2f"|format(account.total_advances_usd) }}</strong>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="{% if account.balance_usd >= 0 %}text-success{% else %}text-danger{% endif %}">
                                <strong>${{ "%.2f"|format(account.balance_usd) }}</strong>
                            </td>
                            <td class="{% if account.balance_lbp >= 0 %}text-success{% else %}text-danger{% endif %}">
                                <strong>{{ "%.0f"|format(account.balance_lbp) }} Ù„.Ù„</strong>
                            </td>
                            <td>
                                {% if account.balance_usd >= 0 %}
                                    <span class="badge bg-success">âœ… Ø±ØµÙŠØ¯ Ù…ÙˆØ¬Ø¨</span>
                                {% elif account.total_advances_usd > 0 %}
                                    <span class="badge bg-warning">âš ï¸ Ù„Ù‡ Ø³Ù„ÙØ©</span>
                                {% else %}
                                    <span class="badge bg-secondary">ğŸŸ¢ Ø¨Ø¯ÙˆÙ† Ø³Ù„ÙØ©</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-dark">
                        <tr>
                            <td colspan="1" class="text-center">
                                <strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ø§Ù„ ({{ total_workers }})</strong>
                            </td>
                            <td class="text-info">
                                <strong>{{ "%.1f"|format(total_all_hours) }}</strong> Ø³Ø§Ø¹Ø©
                            </td>
                            <td colspan="2" class="text-center">
                                <em>Ù…ØªÙˆØ³Ø· Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø§Ù…Ù„</em>
                            </td>
                            <td class="text-success">
                                <strong>${{ "%.2f"|format(total_all_earnings_usd) }}</strong>
                            </td>
                            <td class="text-success">
                                <strong>{{ "%.0f"|format(total_all_earnings_lbp) }} Ù„.Ù„</strong>
                            </td>
                            <td class="text-warning">
                                <strong>${{ "%.2f"|format(total_all_advances_usd) }}</strong>
                            </td>
                            <td class="{% if total_all_balance_usd >= 0 %}text-success{% else %}text-danger{% endif %}">
                                <strong>${{ "%.2f"|format(total_all_balance_usd) }}</strong>
                            </td>
                            <td class="{% if total_all_balance_lbp >= 0 %}text-success{% else %}text-danger{% endif %}">
                                <strong>{{ "%.0f"|format(total_all_balance_lbp) }} Ù„.Ù„</strong>
                            </td>
                            <td class="text-center">
                                {% if total_all_balance_usd >= 0 %}
                                    <span class="badge bg-success">âœ… Ø¥ÙŠØ¬Ø§Ø¨ÙŠ</span>
                                {% else %}
                                    <span class="badge bg-danger">âŒ Ø³Ù„Ø¨ÙŠ</span>
                                {% endif %}
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="card">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>ÙˆÙ‚Øª Ø§Ù„Ø­Ø¶ÙˆØ±</th>
                        <th>ÙˆÙ‚Øª Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©</th>
                        <th>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</th>
                        <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    {% if attendance_records.items %}
                        {% for record in attendance_records.items %}
                        <tr>
                            <td>{{ record.worker.name }}</td>
                            <td>{{ record.date.strftime('%Y-%m-%d') }}</td>
                            <td>
                                {% if record.status == 'Ø­Ø§Ø¶Ø±' %}
                                    <span class="badge bg-success">{{ record.status }}</span>
                                {% elif record.status == 'Ù†ØµÙ ÙŠÙˆÙ…' %}
                                    <span class="badge bg-warning">{{ record.status }}</span>
                                {% else %}
                                    <span class="badge bg-danger">{{ record.status }}</span>
                                {% endif %}
                            </td>
                            <td>{{ record.check_in_time or '-' }}</td>
                            <td>{{ record.check_out_time or '-' }}</td>
                            <td>{{ record.hours_worked }}</td>
                            <td>{{ record.notes or '-' }}</td>
                            <td>
                                <a href="{{ url_for('attendance.edit_attendance', attendance_id=record.id) }}" class="btn btn-sm btn-warning">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <form method="post" action="{{ url_for('attendance.delete_attendance', attendance_id=record.id) }}" style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Ù‡Ù„ Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                                {% if current_user.is_admin %}
                                <form method="post" action="{{ url_for('settings.admin_delete_attendance', attendance_id=record.id) }}" style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-dark" onclick="return confirm('Ø­Ø°Ù ÙƒØ§Ù…Ù„ Ù„Ù„Ø¥Ø¯Ù…Ù† - Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')" title="Ø­Ø°Ù ÙƒØ§Ù…Ù„ Ù„Ù„Ø¥Ø¯Ù…Ù†">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø¶ÙˆØ±</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    {% if attendance_records.pages > 1 %}
    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            {% if attendance_records.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('attendance.attendance_list', page=attendance_records.prev_num) }}">Ø§Ù„Ø³Ø§Ø¨Ù‚</a>
                </li>
            {% endif %}
            
            {% for page_num in attendance_records.iter_pages() %}
                {% if page_num %}
                    {% if page_num == attendance_records.page %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                    {% else %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('attendance.attendance_list', page=page_num) }}">{{ page_num }}</a>
                        </li>
                    {% endif %}
                {% endif %}
            {% endfor %}
            
            {% if attendance_records.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('attendance.attendance_list', page=attendance_records.next_num) }}">Ø§Ù„ØªØ§Ù„ÙŠ</a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>
{% endblock %}
